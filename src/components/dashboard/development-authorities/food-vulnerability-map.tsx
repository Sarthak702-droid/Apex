
'use client';

import { APIProvider, Map, AdvancedMarker } from '@vis.gl/react-google-maps';
import { Badge } from '@/components/ui/badge';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';

type LandUse = { name: string; value: number; fill: string; };

export type Zone = {
    id: string;
    name: string;
    position: { lat: number; lng: number };
    vulnerability: 'low' | 'medium' | 'high';
    description: string;
    stats?: {
        population: string;
        warehouses: number;
        retailStores: number;
        landUse: LandUse[];
    };
};


const zones: Zone[] = [
    { 
        id: 'patia', name: 'Patia', position: { lat: 20.35, lng: 85.82 }, vulnerability: 'low', 
        description: "IT hub, high-income residential area with good access to modern retail. Low vulnerability due to high purchasing power and well-developed infrastructure.",
        stats: { population: '150k', warehouses: 12, retailStores: 150, landUse: [ { name: 'Residential', value: 60, fill: 'hsl(var(--chart-1))' }, { name: 'Commercial', value: 30, fill: 'hsl(var(--chart-2))' }, { name: 'Institutional', value: 10, fill: 'hsl(var(--chart-3))' } ] }
    },
    { 
        id: 'kharabela-nagar', name: 'Kharabela Nagar', position: { lat: 20.28, lng: 85.84 }, vulnerability: 'medium', 
        description: "Commercial hub, dense population, dependent on daily market supply. Medium vulnerability due to high density and reliance on just-in-time supplies.",
        stats: { population: '80k', warehouses: 5, retailStores: 300, landUse: [ { name: 'Commercial', value: 50, fill: 'hsl(var(--chart-2))' }, { name: 'Residential', value: 40, fill: 'hsl(var(--chart-1))' }, { name: 'Mixed', value: 10, fill: 'hsl(var(--chart-4))' } ] }
    },
    { 
        id: 'old-town', name: 'Old Town', position: { lat: 20.24, lng: 85.83 }, vulnerability: 'high', 
        description: "Historical area, narrow roads, potential logistics challenges during crises. High vulnerability from poor last-mile access and older infrastructure.",
        stats: { population: '60k', warehouses: 2, retailStores: 120, landUse: [ { name: 'Residential', value: 70, fill: 'hsl(var(--chart-1))' }, { name: 'Heritage', value: 20, fill: 'hsl(var(--chart-5))' }, { name: 'Commercial', value: 10, fill: 'hsl(var(--chart-2))' } ] }
    },
    { 
        id: 'mancheswar', name: 'Mancheswar', position: { lat: 20.30, lng: 85.86 }, vulnerability: 'low', 
        description: "Industrial estate with large warehouses and good transport links. Low vulnerability due to being a primary storage and logistics node.",
        stats: { population: '40k', warehouses: 45, retailStores: 50, landUse: [ { name: 'Industrial', value: 80, fill: 'hsl(var(--chart-4))' }, { name: 'Residential', value: 15, fill: 'hsl(var(--chart-1))' }, { name: 'Commercial', value: 5, fill: 'hsl(var(--chart-2))' } ] }
    },
    { 
        id: 'saheed-nagar', name: 'Saheed Nagar', position: { lat: 20.29, lng: 85.845 }, vulnerability: 'medium', 
        description: "Busy residential & commercial area, relies heavily on daily market supplies. Medium vulnerability from traffic congestion and high daily demand.",
        stats: { population: '120k', warehouses: 8, retailStores: 250, landUse: [ { name: 'Residential', value: 55, fill: 'hsl(var(--chart-1))' }, { name: 'Commercial', value: 45, fill: 'hsl(var(--chart-2))' } ] }
    },
    { 
        id: 'chandrasekharpur', name: 'Chandrasekharpur', position: { lat: 20.33, lng: 85.80 }, vulnerability: 'low', 
        description: "Well-planned large residential area with multiple large-format retail stores. Low vulnerability due to modern infrastructure and diverse retail options.",
        stats: { population: '180k', warehouses: 15, retailStores: 180, landUse: [ { name: 'Residential', value: 65, fill: 'hsl(var(--chart-1))' }, { name: 'Institutional', value: 20, fill: 'hsl(var(--chart-3))' }, { name: 'Commercial', value: 15, fill: 'hsl(var(--chart-2))' } ] }
    },
    { 
        id: 'nayapalli', name: 'Nayapalli', position: { lat: 20.295, lng: 85.815 }, vulnerability: 'medium', 
        description: "Dense residential area with mix of organized and unorganized retail. Medium vulnerability due to population density and mixed-quality infrastructure.",
        stats: { population: '130k', warehouses: 7, retailStores: 200, landUse: [ { name: 'Residential', value: 70, fill: 'hsl(var(--chart-1))' }, { name: 'Commercial', value: 20, fill: 'hsl(var(--chart-2))' }, { name: 'Government', value: 10, fill: 'hsl(var(--chart-5))' } ] }
    },
    { 
        id: 'unit-1-market', name: 'Unit 1 Market', position: { lat: 20.27, lng: 85.84 }, vulnerability: 'high', 
        description: "Central and oldest market, highly congested with critical supply dependencies. High vulnerability due to single-point-of-failure risk.",
        stats: { population: '10k', warehouses: 3, retailStores: 500, landUse: [ { name: 'Commercial', value: 90, fill: 'hsl(var(--chart-2))' }, { name: 'Mixed', value: 10, fill: 'hsl(var(--chart-4))' } ] }
    },
    { 
        id: 'baramunda', name: 'Baramunda', position: { lat: 20.275, lng: 85.79 }, vulnerability: 'high', 
        description: "Major transit hub (bus terminal), high transient population, vulnerable to transport strikes. High vulnerability due to dependency on state-wide transport.",
        stats: { population: '50k', warehouses: 4, retailStores: 100, landUse: [ { name: 'Transport', value: 50, fill: 'hsl(var(--chart-5))' }, { name: 'Residential', value: 30, fill: 'hsl(var(--chart-1))' }, { name: 'Commercial', value: 20, fill: 'hsl(var(--chart-2))' } ] }
    },
    { 
        id: 'rasulgarh', name: 'Rasulgarh', position: { lat: 20.29, lng: 85.86 }, vulnerability: 'medium', 
        description: "A major traffic intersection and commercial area, prone to congestion which can delay supplies. Medium vulnerability due to potential traffic bottlenecks.",
        stats: { population: '70k', warehouses: 6, retailStores: 180, landUse: [ { name: 'Commercial', value: 40, fill: 'hsl(var(--chart-2))' }, { name: 'Residential', value: 40, fill: 'hsl(var(--chart-1))' }, { name: 'Industrial', value: 20, fill: 'hsl(var(--chart-4))' } ] }
    },
    { 
        id: 'jaydev-vihar', name: 'Jaydev Vihar', position: { lat: 20.305, lng: 85.815 }, vulnerability: 'low', 
        description: "Affluent residential and commercial hub with good road networks and multiple retail options. Low vulnerability due to strong economic base and infrastructure.",
        stats: { population: '90k', warehouses: 10, retailStores: 220, landUse: [ { name: 'Residential', value: 50, fill: 'hsl(var(--chart-1))' }, { name: 'Commercial', value: 40, fill: 'hsl(var(--chart-2))' }, { name: 'Recreational', value: 10, fill: 'hsl(var(--chart-3))' } ] }
    },
    { 
        id: 'pokhariput', name: 'Pokhariput', position: { lat: 20.25, lng: 85.80 }, vulnerability: 'low', 
        description: "Large, planned residential area with good internal infrastructure and local markets. Low vulnerability due to good planning and self-contained markets.",
        stats: { population: '110k', warehouses: 8, retailStores: 90, landUse: [ { name: 'Residential', value: 80, fill: 'hsl(var(--chart-1))' }, { name: 'Institutional', value: 10, fill: 'hsl(var(--chart-3))' }, { name: 'Commercial', value: 10, fill: 'hsl(var(--chart-2))' } ] }
    },
    { 
        id: 'sundarpada', name: 'Sundarpada', position: { lat: 20.23, lng: 85.80 }, vulnerability: 'medium', 
        description: "A rapidly developing residential area with growing demand and evolving infrastructure. Medium vulnerability as infrastructure may lag behind demand.",
        stats: { population: '95k', warehouses: 3, retailStores: 70, landUse: [ { name: 'Residential', value: 85, fill: 'hsl(var(--chart-1))' }, { name: 'Undeveloped', value: 10, fill: 'hsl(var(--chart-5))' }, { name: 'Commercial', value: 5, fill: 'hsl(var(--chart-2))' } ] }
    },
    { 
        id: 'unit-6', name: 'Unit 6', position: { lat: 20.27, lng: 85.83 }, vulnerability: 'low', 
        description: "Government residential area, well-planned with stable access to supplies. Low vulnerability due to organized structure and stable demand.",
        stats: { population: '45k', warehouses: 2, retailStores: 40, landUse: [ { name: 'Government', value: 50, fill: 'hsl(var(--chart-5))' }, { name: 'Residential', value: 50, fill: 'hsl(var(--chart-1))' } ] }
    },
    { 
        id: 'unit-4', name: 'Unit 4', position: { lat: 20.28, lng: 85.83 }, vulnerability: 'medium', 
        description: "Mixed-use area with local markets, subject to some supply pressure due to density. Medium vulnerability from reliance on smaller, less resilient retailers.",
        stats: { population: '55k', warehouses: 4, retailStores: 150, landUse: [ { name: 'Residential', value: 60, fill: 'hsl(var(--chart-1))' }, { name: 'Commercial', value: 40, fill: 'hsl(var(--chart-2))' } ] }
    },
    { 
        id: 'unit-8', name: 'Unit 8', position: { lat: 20.30, lng: 85.82 }, vulnerability: 'low', 
        description: "Well-connected institutional and residential area with good infrastructure. Low vulnerability due to planned development and access to major routes.",
        stats: { population: '65k', warehouses: 9, retailStores: 80, landUse: [ { name: 'Institutional', value: 40, fill: 'hsl(var(--chart-3))' }, { name: 'Residential', value: 50, fill: 'hsl(var(--chart-1))' }, { name: 'Commercial', value: 10, fill: 'hsl(var(--chart-2))' } ] }
    },
    { 
        id: 'khandagiri', name: 'Khandagiri', position: { lat: 20.26, lng: 85.78 }, vulnerability: 'medium', 
        description: "Significant residential area with tourism, potential for supply chain stress. Medium vulnerability due to seasonal population fluctuations from tourism.",
        stats: { population: '100k', warehouses: 6, retailStores: 130, landUse: [ { name: 'Residential', value: 60, fill: 'hsl(var(--chart-1))' }, { name: 'Heritage', value: 20, fill: 'hsl(var(--chart-5))' }, { name: 'Commercial', value: 20, fill: 'hsl(var(--chart-2))' } ] }
    },
    { 
        id: 'dumuduma', name: 'Dumuduma', position: { lat: 20.24, lng: 85.79 }, vulnerability: 'high', 
        description: "Densely populated residential area, posing challenges for last-mile logistics. High vulnerability due to high demand density and potential for congestion.",
        stats: { population: '140k', warehouses: 3, retailStores: 110, landUse: [ { name: 'Residential', value: 90, fill: 'hsl(var(--chart-1))' }, { name: 'Commercial', value: 10, fill: 'hsl(var(--chart-2))' } ] }
    },
];

const vulnerabilityStyles = {
    low: 'bg-green-500/80 hover:bg-green-600 border-green-700/80',
    medium: 'bg-yellow-500/80 hover:bg-yellow-600 border-yellow-700/80',
    high: 'bg-red-500/80 hover:bg-red-600 border-red-700/80',
};

const mapStyles: google.maps.MapTypeStyle[] = [
    { elementType: 'geometry', stylers: [{ color: '#242f3e' }] },
    { elementType: 'labels.text.stroke', stylers: [{ color: '#242f3e' }] },
    { elementType: 'labels.text.fill', stylers: [{ color: '#746855' }] },
    {
      featureType: 'administrative.locality',
      elementType: 'labels.text.fill',
      stylers: [{ color: '#d59563' }],
    },
    {
      featureType: 'poi',
      stylers: [{ visibility: 'off' }],
    },
    {
      featureType: 'road',
      elementType: 'geometry',
      stylers: [{ color: '#38414e' }],
    },
    {
      featureType: 'road',
      elementType: 'geometry.stroke',
      stylers: [{ color: '#212a37' }],
    },
    {
      featureType: 'road',
      elementType: 'labels.text.fill',
      stylers: [{ color: '#9ca5b3' }],
    },
    {
      featureType: 'road.highway',
      elementType: 'geometry',
      stylers: [{ color: '#746855' }],
    },
    {
      featureType: 'road.highway',
      elementType: 'geometry.stroke',
      stylers: [{ color: '#1f2835' }],
    },
    {
      featureType: 'road.highway',
      elementType: 'labels.text.fill',
      stylers: [{ color: '#f3d19c' }],
    },
    {
      featureType: 'transit',
      stylers: [{ visibility: 'off' }],
    },
    {
      featureType: 'water',
      elementType: 'geometry',
      stylers: [{ color: '#17263c' }],
    },
    {
      featureType: 'water',
      elementType: 'labels.text.fill',
      stylers: [{ color: '#515c6d' }],
    },
    {
      featureType: 'water',
      elementType: 'labels.text.stroke',
      stylers: [{ color: '#17263c' }],
    },
];

type FoodVulnerabilityMapProps = {
    selectedZone: Zone | null;
    onSelectZone: (zone: Zone | null) => void;
}

export function FoodVulnerabilityMap({ selectedZone, onSelectZone }: FoodVulnerabilityMapProps) {
    if (!process.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY) {
        return (
            <div className="flex items-center justify-center h-full bg-muted/30 p-4 text-center rounded-lg border">
                <p className='text-muted-foreground'>Google Maps API key is not configured. Please add it to your environment variables as NEXT_PUBLIC_GOOGLE_MAPS_API_KEY.</p>
            </div>
        );
    }
    
    return (
        <div className="relative w-full aspect-[16/9] bg-muted/30 rounded-lg overflow-hidden border">
            <APIProvider apiKey={process.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY}>
                <Map
                    defaultCenter={{ lat: 20.2961, lng: 85.8245 }}
                    defaultZoom={12}
                    mapId="a2b3c4d5e6f7g8h9"
                    styles={mapStyles}
                    disableDefaultUI={true}
                    gestureHandling={'greedy'}
                >
                    {zones.map(zone => (
                        <AdvancedMarker 
                            key={zone.id} 
                            position={zone.position}
                            onClick={() => onSelectZone(zone)}
                        >
                            <Badge
                                className={`cursor-pointer transition-all text-white border-2 ${selectedZone?.id === zone.id ? 'border-white' : 'border-white/50'} ${vulnerabilityStyles[zone.vulnerability as keyof typeof vulnerabilityStyles]}`}
                            >
                                {zone.name}
                            </Badge>
                        </AdvancedMarker>
                    ))}
                </Map>
            </APIProvider>
            
            <div className="absolute bottom-4 right-4 bg-background/80 p-3 rounded-md border shadow-lg">
                <h4 className="font-semibold text-xs mb-2">Vulnerability Legend</h4>
                <div className="flex flex-col gap-2">
                    <div className="flex items-center gap-2">
                        <div className="h-3 w-3 rounded-full bg-green-500"></div>
                        <span className="text-xs">Low Risk</span>
                    </div>
                    <div className="flex items-center gap-2">
                        <div className="h-3 w-3 rounded-full bg-yellow-500"></div>
                        <span className="text-xs">Medium Risk</span>
                    </div>
                    <div className="flex items-center gap-2">
                        <div className="h-3 w-3 rounded-full bg-red-500"></div>
                        <span className="text-xs">High Risk</span>
                    </div>
                </div>
            </div>

            {selectedZone && (
                <Card className='absolute top-4 left-4 w-64 bg-background/90 backdrop-blur-sm'>
                    <CardHeader className='p-4'>
                        <CardTitle className='text-base'>{selectedZone.name}</CardTitle>
                        <CardDescription>Vulnerability: <span className={`capitalize font-semibold ${
                            selectedZone.vulnerability === 'high' ? 'text-red-500' : 
                            selectedZone.vulnerability === 'medium' ? 'text-yellow-500' : 'text-green-500'
                        }`}>{selectedZone.vulnerability}</span></CardDescription>
                    </CardHeader>
                    <CardContent className='p-4 pt-0'>
                        <Button variant='link' className='p-0 h-auto mt-2 text-xs' onClick={() => onSelectZone(null)}>Close</Button>
                    </CardContent>
                </Card>
            )}
        </div>
    );
}
